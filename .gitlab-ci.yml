image: foolnofool/node-minio:latest

stages:
  - install
  - build
  - deploy

cache:
  key: ${CI_BUILD_REF_NAME}
  paths:
    - template/node_modules

.common_script:
  only:
    - tags
    - master
    - /^release.*$/
    - /^feat/castle/.*$/ # ä¸´æ—¶è°ƒè¯•åˆ†æ”¯
  tags:
    - castle

install-job:
  stage: install
  extends: .common_script
  script:
    - cd template
    - node -v
    - npm -v
    - yarn -v
    - echo "ğŸ§© å¼€å§‹å®‰è£…ä¾èµ–"
    - yarn --registry=http://castle-npm.cp.hxdi.cn/

build-job:
  stage: build
  extends: .common_script
  artifacts:
    name: "dist"
    expire_in: 2 weeks
    paths:
      - template/dist/
  script:
    - echo "â° å¼€å§‹ä»£ç æ‰“åŒ…"
    - yarn build

deploy-job:
  stage: deploy
  extends: .common_script
  variables:
    DELETE_CURL_API: '${CASTLE_SERVICE_ENDPOINT}/minio/remove/folder/expire?bucketName=${MINIO_BUCKET}&folderPrefix=${CI_PROJECT_NAME}%2Ftest%2F'
  before_script:
    - sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories
    - apk add curl
  script:
    - echo "ğŸš€ éƒ¨ç½²ä»£ç "
    - echo ${MINIO_ENDPOINT} ${MINIO_BUCKET} ${MINIO_ACCESS_KEY} ${MINIO_SECRET_KEY}
    # è®¾ç½® MinIO åˆ«åå’Œè®¤è¯ä¿¡æ¯ï¼Œè¿æ¥MinIO
    - mc config host add minio ${MINIO_ENDPOINT} ${MINIO_ACCESS_KEY} ${MINIO_SECRET_KEY}
    - echo "åˆ é™¤ç›®å½•ç©ºæ–‡ä»¶ç›®å½•ï¼Œåˆ é™¤æ¥å£ï¼š$DELETE_CURL_API"
    # åˆ é™¤è¯¥é¡¹ç›®ä¸‹è¿‡æœŸç‰ˆæœ¬çš„ç©ºæ–‡ä»¶å¤¹
    - curl --location $DELETE_CURL_API
    # ç”Ÿæˆç›®æ ‡è·¯å¾„
    - export FOLDER_NAME="minio/${MINIO_BUCKET}/${CI_PROJECT_NAME}/test/${CI_COMMIT_SHA:0:8}"
    - echo "MinIOç›®æ ‡ç›®å½•åä¸ºï¼š$FOLDER_NAME"
    - mc rm -r --force $FOLDER_NAME
    - echo "å°† dist ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å¤åˆ¶åˆ° MinIO ä¸‹:$FOLDER_NAME"
    - mc cp -r template/dist/ $FOLDER_NAME
    - echo "ğŸ‰ å®Œæˆï¼"
